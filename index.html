<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Fertilizer Mixer Pro (Final Completed)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- CSS Variables --- */
        :root {
            --primary-color: #05CD99;
            --primary-light: #E9FAF5;
            --primary-dark: #02A176;
            --secondary-color: #4318FF;
            --secondary-light: #EAE6FF;
            --bg-color: #F4F7FE;
            --text-main: #2B3674;
            --text-secondary: #A3AED0;
            --danger-color: #EE5D50;
            --danger-light: #FEEFEE;
            --warning-color: #FFCE20;
            --success-color: #00E676;
            --sidebar-width: 260px;
            --shadow-sm: 0 2px 12px rgba(0,0,0,0.04);
            --shadow-md: 0 5px 20px rgba(112, 144, 176, 0.12);
        }

        /* --- Global Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-color); color: var(--text-main); font-size: 15px; overflow-x: hidden; }

        /* --- Layout & Login --- */
        #loginPage { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #E0F7FA 0%, #E8EAF6 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 50px 40px; border-radius: 24px; width: 90%; max-width: 420px; box-shadow: var(--shadow-md); text-align: center; }
        .login-input { width: 100%; padding: 16px; margin-bottom: 20px; border: 1px solid #E0E5F2; border-radius: 16px; font-family: 'Prompt'; background: #FAFCFE; font-size: 16px; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(5, 205, 153, 0.1); background: white; }
        .btn-login { width: 100%; padding: 16px; background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 16px; font-weight: 600; cursor: pointer; font-size: 16px; box-shadow: 0 10px 20px rgba(5, 205, 153, 0.3); transition: transform 0.2s; }
        .btn-login:hover { transform: translateY(-2px); }

        /* --- LOGIN ERROR (MINIMAL STYLE) --- */
        .login-error-msg {
            display: none;
            color: var(--danger-color);
            font-size: 14px;
            margin-bottom: 20px;
            text-align: left;
            font-weight: 500;
            align-items: center;
            gap: 8px;
            animation: shake 0.4s ease-in-out;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .remember-box { display: flex; align-items: center; justify-content: flex-start; gap: 10px; margin-bottom: 25px; width: 100%; padding-left: 5px; }
        .remember-box input[type="checkbox"] { accent-color: var(--primary-color); width: 18px; height: 18px; cursor: pointer; }
        .remember-box label { font-size: 14px; color: var(--text-secondary); cursor: pointer; user-select: none; }

        #appContainer { display: none; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: white; position: fixed; height: 100%; top: 0; left: 0; display: flex; flex-direction: column; z-index: 1000; padding: 30px 20px; border-right: 1px solid #F0F0F0; transition: transform 0.3s ease; }
        .brand { text-align: center; margin-bottom: 50px; }
        .brand h2 { color: var(--text-main); margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
        .brand span { color: var(--primary-color); }
        .menu { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .menu-item { display: flex; align-items: center; padding: 14px 20px; color: var(--text-secondary); text-decoration: none; border-radius: 14px; font-weight: 500; transition: all 0.3s; cursor: pointer; }
        .menu-item:hover { background: var(--bg-color); color: var(--text-main); }
        .menu-item.active { background: var(--primary-color); color: white; box-shadow: 0 10px 20px rgba(5, 205, 153, 0.25); }
        .menu-item.active i { color: white; }
        .menu-item i { width: 25px; font-size: 18px; margin-right: 10px; }

        .main-content { margin-left: var(--sidebar-width); padding: 40px; width: calc(100% - var(--sidebar-width)); transition: margin 0.3s; }
        .page-section { display: none; animation: fadeIn 0.4s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
        .page-title { display: flex; align-items: center; gap: 15px; }
        .page-title h1 { font-size: 30px; font-weight: 700; color: var(--text-main); margin: 0; letter-spacing: -0.5px; }
        
        /* Mobile Menu Button */
        .menu-toggle-btn { display: none; font-size: 24px; color: var(--text-main); cursor: pointer; background: none; border: none; }
        .overlay-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }

        .connection-status { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; background: white; padding: 10px 20px; border-radius: 30px; box-shadow: var(--shadow-sm); color: var(--primary-color); }
        .dot.online { width: 10px; height: 10px; border-radius: 50%; background: var(--success-color); box-shadow: 0 0 10px var(--success-color); animation: blink 2s infinite; }

        /* --- Components --- */
        .grid-container { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: var(--shadow-sm); transition: transform 0.3s, box-shadow 0.3s; border: 1px solid transparent; }
        .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: #E0E5F2; }
        
        .sensor-card { grid-column: span 3; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .sensor-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .sensor-title { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; transition: all 0.3s; }
        .icon-ec { background: var(--primary-light); color: var(--primary-color); }
        .icon-ph { background: var(--secondary-light); color: var(--secondary-color); }
        .icon-temp { background: #FFF7E6; color: var(--warning-color); }
        .icon-flow { background: var(--danger-light); color: var(--danger-color); }
        .sensor-val { font-size: 38px; font-weight: 700; color: var(--text-main); line-height: 1; letter-spacing: -1px; }
        .sensor-target { font-size: 13px; color: var(--text-secondary); background: var(--bg-color); padding: 6px 12px; border-radius: 8px; display: inline-flex; gap: 6px; margin-top: 10px; align-self: flex-start; align-items: center; }
        
        .tank-section { grid-column: span 12; display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-top: 10px; }
        .tank-box { text-align: center; background: white; padding: 30px 20px; border-radius: 20px; box-shadow: var(--shadow-sm); transition: 0.3s; }
        .tank-box:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .glass-tube { height: 140px; width: 60px; margin: 0 auto 20px; background: var(--bg-color); border-radius: 30px; position: relative; overflow: hidden; border: 4px solid #fff; box-shadow: inset 0 0 15px rgba(0,0,0,0.05); }
        .liquid { position: absolute; bottom: 0; left: 0; width: 100%; transition: height 0.1s linear; border-radius: 0 0 25px 25px; }
        .tank-label { font-weight: 600; color: var(--text-main); font-size: 16px; }
        
        /* Device Control Styles */
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-switch-container { display: flex; align-items: center; background: #F4F7FE; border-radius: 30px; padding: 4px; position: relative; width: 180px; height: 45px; cursor: pointer; user-select: none; border: 1px solid #E0E5F2; }
        .mode-option { flex: 1; text-align: center; z-index: 2; font-size: 13px; font-weight: 700; color: var(--text-secondary); transition: 0.3s; }
        .mode-option.active { color: white; }
        .mode-bg { position: absolute; top: 4px; left: 4px; width: 50%; height: calc(100% - 8px); background: var(--primary-color); border-radius: 25px; transition: 0.3s; z-index: 1; box-shadow: 0 4px 10px rgba(5, 205, 153, 0.3); }
        .mode-switch-container.manual .mode-bg { left: 50%; background: var(--warning-color); box-shadow: 0 4px 10px rgba(255, 206, 32, 0.4); }
        .mode-switch-container.manual { border-color: var(--warning-color); }
        
        .device-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .device-card { background: #FAFCFE; border: 1px solid #E0E5F2; border-radius: 16px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .device-grid.auto-mode .device-card { opacity: 0.8; }
        .device-card:hover { border-color: var(--primary-color); background: white; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .device-card.active { background: #E9FAF5 !important; border-color: var(--success-color) !important; box-shadow: 0 0 0 2px var(--success-color) inset !important; }
        .device-icon { font-size: 28px; color: var(--text-secondary); margin-bottom: 12px; transition: 0.3s; display: inline-block; }
        .device-card.active .device-icon { color: var(--success-color) !important; }
        .device-name { font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 5px; }
        .device-status { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .device-card.active .device-status { color: var(--success-color) !important; }

        /* Search Box Styles */
        .search-container { display: flex; align-items: center; background: #F4F7FE; border-radius: 12px; padding: 0 15px; height: 45px; width: 250px; border: 1px solid transparent; transition: 0.3s; }
        .search-container:focus-within { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 3px rgba(5, 205, 153, 0.1); }
        .search-input { border: none; background: transparent; outline: none; font-family: 'Prompt'; font-size: 14px; color: var(--text-main); width: 100%; margin-left: 10px; }
        .search-icon { color: var(--text-secondary); font-size: 14px; }

        /* Table Styles */
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        .custom-table th { text-align: left; padding: 15px 20px; color: var(--text-secondary); font-weight: 600; font-size: 13px; border-bottom: 2px solid #F0F0F0; background-color: #FAFCFE; text-transform: uppercase; letter-spacing: 0.5px; }
        .custom-table th:first-child { border-top-left-radius: 12px; }
        .custom-table th:last-child { border-top-right-radius: 12px; }
        .custom-table td { padding: 18px 20px; color: var(--text-main); border-bottom: 1px solid #F4F7FE; font-size: 15px; vertical-align: middle; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover td { background-color: #FAFCFE; }
        
        .date-header td { background-color: #f0f2f5; font-weight: 700; color: var(--text-main); padding-top: 25px !important; padding-bottom: 10px !important; font-size: 16px; border-bottom: 1px solid #e0e5f2; }

        .status-badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .bg-pending { background: #FFF7E6; color: #FFB547; }
        .bg-success { background: var(--primary-light); color: var(--primary-color); }
        .bg-disabled { background: var(--bg-color); color: var(--text-secondary); text-decoration: line-through; }
        .bg-active { background: var(--secondary-light); color: var(--secondary-color); animation: pulse 2s infinite; }

        .row-running td { background-color: #E9FAF5 !important; }
        .row-running td:first-child { border-left: 4px solid var(--primary-color); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Button Styling */
        .btn-sm { padding: 8px 14px; border-radius: 10px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-view { background: #F4F7FE; color: var(--text-main); border: 1px solid #E0E5F2; } 
        .btn-view:hover { background: white; border-color: var(--text-secondary); transform: translateY(-1px); }
        .btn-toggle { background: #E0E5F2; color: var(--text-secondary); }
        .btn-toggle.active { background: var(--success-color); color: white; box-shadow: 0 4px 10px rgba(0, 230, 118, 0.3); }
        .btn-add { background: var(--primary-light); color: var(--primary-color); }
        .btn-add:hover { background: var(--primary-color); color: white; transform: translateY(-1px); }
        .btn-del { background: var(--danger-light); color: var(--danger-color); }
        .btn-del:hover { background: var(--danger-color); color: white; transform: translateY(-1px); }

        .action-buttons { display: flex; gap: 8px; align-items: center; } 

        .control-bar { grid-column: span 12; display: flex; justify-content: flex-end; gap: 15px; padding: 20px 0; }
        .btn-action { padding: 14px 30px; border-radius: 14px; border: none; font-size: 16px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: transform 0.2s, box-shadow 0.2s; }
        .btn-primary { background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 10px 20px rgba(5, 205, 153, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 25px rgba(5, 205, 153, 0.4); }
        .btn-danger { background: white; color: var(--danger-color); border: 2px solid var(--danger-color); }
        .btn-danger:hover { background: var(--danger-color); color: white; }

        /* Modal Beautification */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-box { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 650px; animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { font-weight: 600; font-size: 14px; color: var(--text-main); display: block; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid #E0E5F2; border-radius: 12px; font-family: 'Prompt'; font-size: 15px; outline: none; transition: 0.3s; background: #FAFCFE; }
        .form-control:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 4px rgba(5, 205, 153, 0.1); }
        
        .time-tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .time-tag { background: var(--primary-light); color: var(--primary-dark); padding: 8px 16px; border-radius: 30px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; transition: 0.2s; }
        .time-tag:hover { border-color: var(--primary-color); background: white; }
        .time-tag i { cursor: pointer; color: #aaa; transition: 0.2s; }
        .time-tag i:hover { color: var(--danger-color); }
        .add-time-box { display: flex; gap: 10px; margin-top: 5px; }

        /* Custom Styles for Nested Recipe Creator */
        .stage-block { border: 1px solid #E0E5F2; padding: 15px; border-radius: 16px; margin-bottom: 15px; background: #FAFCFE; transition: 0.3s; }
        .stage-block:hover { border-color: var(--primary-color); box-shadow: var(--shadow-sm); background: white; }
        .sub-rows-container { margin-top: 10px; padding-left: 10px; border-left: 2px solid #E0E5F2; }
        .sub-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr 40px; gap: 10px; margin-bottom: 8px; align-items: center; }
        .btn-sq { width: 36px; height: 36px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; }
        .btn-sq-add { background: var(--primary-light); color: var(--primary-dark); }
        .btn-sq-add:hover { background: var(--primary-color); color: white; }
        .btn-sq-del { background: var(--danger-light); color: var(--danger-color); }
        .btn-sq-del:hover { background: var(--danger-color); color: white; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); position: fixed; height: 100%; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); } 
            .sidebar.active { transform: translateX(0); }
            .menu-toggle-btn { display: block; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; } 
            .grid-container { display: flex; flex-direction: column; } 
            .tank-section { grid-template-columns: 1fr 1fr; } 
            .sensor-card { min-height: auto; } 
            .device-grid { grid-template-columns: repeat(3, 1fr); } 
            .search-container { width: 100%; } 
            .header { margin-bottom: 20px; }
            .page-title h1 { font-size: 24px; }
            .overlay-bg { display: none; }
            .overlay-bg.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="overlay-bg" onclick="toggleSidebar()"></div>

    <div id="loginPage">
        <div class="login-card">
            <h1 style="color:var(--text-main); margin-bottom:10px;">SMART<span style="color:var(--primary-color)">FARM</span></h1>
            <p style="color:var(--text-secondary); margin-bottom:30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏™‡∏°‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <input type="text" id="username" class="login-input" placeholder="Username" required>
                <input type="password" id="password" class="login-input" placeholder="Password" required>
                
                <div id="loginError" class="login-error-msg">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span>Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
                </div>

                <div class="remember-box"><input type="checkbox" id="rememberMe"><label for="rememberMe">‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</label></div>
                <button type="submit" class="btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <div id="appContainer">
        <nav class="sidebar" id="sidebar">
            <div class="brand">
                <h2 style="display:flex; justify-content:space-between; align-items:center;">
                    SMART<span>MIXER</span>
                    <i class="fa-solid fa-xmark" style="font-size:20px; cursor:pointer; display:none;" onclick="toggleSidebar()" id="closeMenuBtn"></i>
                </h2>
            </div>
            <div class="menu">
                <div class="menu-item active" onclick="switchPage('dashboard'); toggleSidebarIfMobile();"><i class="fa-solid fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
                <div class="menu-item" onclick="switchPage('schedule'); toggleSidebarIfMobile();"><i class="fa-solid fa-list-check"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</div>
                <div class="menu-item" onclick="switchPage('formula'); toggleSidebarIfMobile();"><i class="fa-solid fa-seedling"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä</div>
                <div class="menu-item" onclick="switchPage('history'); toggleSidebarIfMobile();"><i class="fa-solid fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
            </div>
            <div style="margin-top:auto;">
                <div class="menu-item" style="color:var(--danger-color);" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>
        </nav>

        <div class="main-content">
            <div class="header">
                <div class="page-title">
                    <button class="menu-toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <h1 id="pageTitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h1>
                </div>
                <div class="connection-status"><div class="dot online"></div> Online</div>
            </div>

            <div id="dashboardSection" class="page-section active">
                <div class="grid-container">
                    <div class="card sensor-card"><div class="sensor-header"><span class="sensor-title">‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πã‡∏¢ (EC)</span><div class="icon-box icon-ec"><i class="fa-solid fa-bolt"></i></div></div><div class="sensor-body"><span class="sensor-val" id="val_ec">1.8</span> <span style="font-size:14px; color:#A3AED0;">mS/cm</span></div><div class="sensor-target"><i class="fa-solid fa-crosshairs"></i> ‡πÄ‡∏õ‡πâ‡∏≤: <strong id="dash_target_ec">-</strong></div></div>
                    <div class="card sensor-card"><div class="sensor-header"><span class="sensor-title">‡∏Ñ‡πà‡∏≤ pH</span><div class="icon-box icon-ph"><i class="fa-solid fa-droplet"></i></div></div><div class="sensor-body"><span class="sensor-val" id="val_ph">6.5</span></div><div class="sensor-target"><i class="fa-solid fa-crosshairs"></i> ‡πÄ‡∏õ‡πâ‡∏≤: <strong id="dash_target_ph">-</strong></div></div>
                    <div class="card sensor-card"><div class="sensor-header"><span class="sensor-title">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</span><div class="icon-box icon-temp"><i class="fa-solid fa-temperature-half"></i></div></div><div class="sensor-body"><span class="sensor-val">28.5</span> <span style="font-size:14px; color:#A3AED0;">¬∞C</span></div><div class="sensor-target"><i class="fa-solid fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</div></div>
                    <div class="card sensor-card">
                        <div class="sensor-header"><span class="sensor-title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><div class="icon-box icon-flow" id="icon_status"><i class="fa-solid fa-robot"></i></div></div>
                        <div class="sensor-body"><span class="sensor-val" style="font-size:24px;" id="sys_status">Standby (Auto)</span></div>
                    </div>

                    <div class="card" style="grid-column: span 12;">
                        <div class="device-header">
                            <h3 style="margin:0; font-size:18px;">üéõÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Device Control)</h3>
                            <div class="mode-switch-container" onclick="toggleSystemMode()">
                                <div class="mode-bg" id="modeBg"></div>
                                <div class="mode-option active" id="modeAuto">AUTO</div>
                                <div class="mode-option" id="modeManual">MANUAL</div>
                            </div>
                        </div>
                        
                        <div class="device-grid auto-mode" id="deviceGrid">
                            <div class="device-card" id="dev_pumpA" onclick="toggleDevice(this)"><div class="device-icon"><i class="fa-solid fa-faucet"></i></div><div class="device-name">‡∏õ‡∏±‡πä‡∏° A</div><div class="device-status">OFF</div></div>
                            <div class="device-card" id="dev_pumpB" onclick="toggleDevice(this)"><div class="device-icon"><i class="fa-solid fa-faucet"></i></div><div class="device-name">‡∏õ‡∏±‡πä‡∏° B</div><div class="device-status">OFF</div></div>
                            <div class="device-card" id="dev_pumpUp" onclick="toggleDevice(this)"><div class="device-icon"><i class="fa-solid fa-arrow-up"></i></div><div class="device-name">‡∏õ‡∏±‡πä‡∏° pH Up</div><div class="device-status">OFF</div></div>
                            <div class="device-card" id="dev_pumpDown" onclick="toggleDevice(this)"><div class="device-icon"><i class="fa-solid fa-arrow-down"></i></div><div class="device-name">‡∏õ‡∏±‡πä‡∏° pH Down</div><div class="device-status">OFF</div></div>
                            <div class="device-card" id="dev_pumpMix" onclick="toggleDevice(this)"><div class="device-icon"><i class="fa-solid fa-magnifying-glass-chart"></i></div><div class="device-name">‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πã‡∏¢</div><div class="device-status">OFF</div></div>
                        </div>
                    </div>

                    <div class="card" style="grid-column: span 12;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; font-size:18px;">üìÖ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today's Queue)</h3>
                            <button class="btn-sm" style="background:var(--primary-light); color:var(--primary-color);" onclick="switchPage('schedule')">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                        <div style="margin-top:15px; overflow-x:auto;">
                            <table class="custom-table" id="todayTable">
                                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏á‡∏≤‡∏ô</th><th>EC ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                                <tbody id="todayTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tank-section">
                        <div class="tank-box"><div class="glass-tube"><div class="liquid" style="height:80%; background:linear-gradient(to top, #FF7043, #FFAB91);"></div></div><div class="tank-label">‡∏õ‡∏∏‡πã‡∏¢ A</div></div>
                        <div class="tank-box"><div class="glass-tube"><div class="liquid" style="height:60%; background:linear-gradient(to top, #FFA000, #FFCA28);"></div></div><div class="tank-label">‡∏õ‡∏∏‡πã‡∏¢ B</div></div>
                        <div class="tank-box"><div class="glass-tube"><div class="liquid" style="height:90%; background:linear-gradient(to top, #7B1FA2, #E1BEE7);"></div></div><div class="tank-label">‡∏Å‡∏£‡∏î</div></div>
                        <div class="tank-box"><div class="glass-tube"><div class="liquid" id="mixTank" style="height:10%; background:linear-gradient(to top, #1976D2, #64B5F6);"></div></div><div class="tank-label">‡∏ñ‡∏±‡∏á‡∏ú‡∏™‡∏°</div></div>
                    </div>

                    <div class="control-bar">
                        <button class="btn-action btn-danger" onclick="emergencyStop()"><i class="fa-solid fa-stop"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</button>
                        <button class="btn-action btn-primary" onclick="runNextJob()"><i class="fa-solid fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
                    </div>
                </div>
            </div>

            <div id="scheduleSection" class="page-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h3 style="margin:0; font-size:20px;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (Main Process)</h3>
                            <p style="color:var(--text-secondary); font-size:13px; margin:5px 0 0 0;">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ 1 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ)</p>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-action btn-primary" style="font-size:14px; padding:10px 20px;" onclick="openAddSingleJobModal()"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
                            <button class="btn-action btn-danger" style="font-size:14px; padding:10px 20px;" onclick="clearSchedule()"><i class="fa-solid fa-trash"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto; max-height: 600px;">
                        <table class="custom-table">
                            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</th><th>‡πÄ‡∏ß‡∏•‡∏≤ (Time)</th><th>‡∏á‡∏≤‡∏ô/‡∏™‡∏π‡∏ï‡∏£ (Task Name)</th><th>EC / pH</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Custom)</th></tr>
                            </thead>
                            <tbody id="scheduleTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="formulaSection" class="page-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; gap:15px;">
                        <h3 style="margin:0; font-size:20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä (Plant Recipes)</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="search-container">
                                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                                <input type="text" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏π‡∏ï‡∏£..." onkeyup="filterRecipes(this.value)">
                            </div>
                            <button class="btn-action btn-primary" style="padding:10px 20px; font-size:14px; white-space:nowrap;" onclick="openCreateRecipeModal()"><i class="fa-solid fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    </div>
                    
                    <table class="custom-table">
                        <thead><tr><th style="width:30%;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="profileTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="historySection" class="page-section">
                <div class="card">
                    <h3 style="margin:0 0 20px 0; font-size:20px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (History Logs)</h3>
                    <table class="custom-table">
                        <thead><tr><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th><th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="createRecipeModal">
        <div class="modal-box" style="max-width: 650px;">
            <h3 style="margin-bottom:20px; text-align:center;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä‡πÉ‡∏´‡∏°‡πà (Advanced)</h3>
            
            <div class="form-group">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä</label>
                <input type="text" class="form-control" id="newRecipeName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏±‡∏ç‡∏ä‡∏≤ (Auto)">
            </div>

            <div class="form-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label class="form-label" style="margin:0;">‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢ (Date Ranges)</label>
                    <button class="btn-action btn-primary" onclick="addStageBlock()" style="font-size:12px; padding: 8px 16px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</button>
                </div>
                
                <div id="stagesContainer" style="max-height:400px; overflow-y:auto; padding-right:5px;">
                    </div>
            </div>

            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; text-align:right;">
                <p style="font-size:14px; color:var(--text-main);">‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong id="totalDaysDisplay" style="color:var(--primary-color);">0</strong> ‡∏ß‡∏±‡∏ô</p>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="flex:1; justify-content:center; background:#F4F7FE; color:var(--text-main);" onclick="closeModal('createRecipeModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-action btn-primary" style="flex:1; justify-content:center;" onclick="confirmCreateRecipe()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addScheduleModal"><div class="modal-box"><h3 style="margin-bottom:20px; text-align:center;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</h3><p style="color:var(--text-secondary); font-size:14px; margin-bottom:25px; text-align:center;">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏π‡∏ï‡∏£ <strong id="modalProfileName" style="color:var(--primary-color);"></strong> ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</p><div class="form-group"><label class="form-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Start Date)</label><input type="date" class="form-control" id="inputStartDate"></div><p style="font-size:13px; color:#aaa; margin-top:10px;">*‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ EC/pH ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p><div style="display:flex; gap:10px; margin-top:30px;"><button class="btn-action" style="flex:1; justify-content:center; background:#F4F7FE; color:var(--text-main);" onclick="closeModal('addScheduleModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn-action btn-primary" style="flex:1; justify-content:center;" onclick="confirmAddToSchedule()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div>
    
    <div class="modal-overlay" id="viewProfileModal"><div class="modal-box"><h3 style="margin-bottom:15px; text-align:center;" id="viewProfileTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏ï‡∏£</h3><div style="overflow-y:auto; max-height:300px; padding: 5px;"><table class="custom-table" style="margin-top:0;"><thead><tr><th>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Ñ‡πà‡∏≤ EC</th><th>‡∏Ñ‡πà‡∏≤ pH</th></tr></thead><tbody id="viewProfileBody"></tbody></table></div><div style="margin-top:25px; text-align: center;"><button class="btn-action" style="background:#F4F7FE; color:var(--text-main); width:100%; justify-content: center;" onclick="closeModal('viewProfileModal')">‡∏õ‡∏¥‡∏î</button></div></div></div>
    <div class="modal-overlay" id="addSingleJobModal"><div class="modal-box"><h3 style="margin-bottom:20px; text-align:center;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Manual Add)</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="newJobDate"></div><div class="form-group"><label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" class="form-control" id="newJobTime"></div></div><div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input type="text" class="form-control" id="newJobName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏£‡∏≠‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©"></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div class="form-group"><label class="form-label">Target EC</label><input type="number" step="0.1" class="form-control" id="newJobEC" value="1.0"></div><div class="form-group"><label class="form-label">Target pH</label><input type="number" step="0.1" class="form-control" id="newJobPH" value="6.0"></div></div><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-action" style="flex:1; justify-content:center; background:#F4F7FE; color:var(--text-main);" onclick="closeModal('addSingleJobModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn-action btn-primary" style="flex:1; justify-content:center;" onclick="saveSingleJob()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button></div></div></div>
    <div class="modal-overlay" id="editJobModal"><div class="modal-box"><h3 style="margin-bottom:20px; text-align:center;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô (Custom)</h3><input type="hidden" id="editJobIndex"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="editJobDate"></div><div class="form-group"><label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" class="form-control" id="editJobTime"></div></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div class="form-group"><label class="form-label">Target EC</label><input type="number" step="0.1" class="form-control" id="editJobEC"></div><div class="form-group"><label class="form-label">Target pH</label><input type="number" step="0.1" class="form-control" id="editJobPH"></div></div><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-action" style="flex:1; justify-content:center; background:#F4F7FE; color:var(--text-main);" onclick="closeModal('editJobModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn-action btn-primary" style="flex:1; justify-content:center;" onclick="saveJobEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div>

    <script>
        // --- DATA STRUCTURE (Nested: Profile -> Stages -> Schedules) ---
        let profiles = [
            { 
                id: 1, name: "‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î (Green Oak)", days: 45, 
                stages: [
                    { 
                        start: 1, end: 14, 
                        schedules: [ {time:"08:00", ec:0.8, ph:6.0} ] 
                    }, 
                    { 
                        start: 15, end: 30, 
                        schedules: [ {time:"08:00", ec:1.2, ph:6.0}, {time:"16:00", ec:1.2, ph:6.0} ] 
                    }, 
                    { 
                        start: 31, end: 45, 
                        schedules: [ {time:"08:00", ec:1.6, ph:6.0}, {time:"16:00", ec:1.6, ph:6.0} ] 
                    }
                ] 
            },
            { 
                id: 2, name: "‡∏Å‡∏±‡∏ç‡∏ä‡∏≤ (Cannabis Auto)", days: 90, 
                stages: [
                    { start: 1, end: 15, schedules: [{time:"09:00", ec:0.6, ph:6.0}] },   
                    { start: 16, end: 45, schedules: [{time:"08:00", ec:1.5, ph:6.2}, {time:"17:00", ec:1.5, ph:6.2}] }, 
                    { start: 46, end: 90, schedules: [{time:"08:00", ec:2.0, ph:6.2}, {time:"12:00", ec:2.0, ph:6.2}, {time:"17:00", ec:2.2, ph:6.2}] }
                ] 
            }
        ];

        let mainSchedule = []; 
        let selectedProfileId = null;
        let activeInterval = null;
        let isManualMode = false;

        // --- AUTH & NAV ---
        function handleLogin() {
            const userIn = document.getElementById('username').value;
            const passIn = document.getElementById('password').value;
            if(userIn === 'admin' && passIn === 'admin') {
                document.getElementById('loginError').style.display = 'none';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('inputStartDate').valueAsDate = new Date();
                document.getElementById('newJobDate').valueAsDate = new Date();
                document.getElementById('newJobTime').value = "09:00";
                renderProfiles(); renderSchedule(); updateDashboard();
            } else { 
                document.getElementById('loginError').style.display = 'flex';
                document.getElementById('password').value = '';
            }
        }
        function handleLogout() { location.reload(); }
        function switchPage(page) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(page + 'Section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const titles = { 'dashboard': '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö', 'schedule': '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (Main Process)', 'formula': '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡∏ä', 'history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á' };
            document.getElementById('pageTitle').innerText = titles[page];
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('active');
            const overlay = document.querySelector('.overlay-bg');
            if(sb.classList.contains('active')) { overlay.style.display = 'block'; document.getElementById('closeMenuBtn').style.display = 'block'; }
            else { overlay.style.display = 'none'; document.getElementById('closeMenuBtn').style.display = 'none'; }
        }
        function toggleSidebarIfMobile() { if(window.innerWidth <= 768) toggleSidebar(); }

        // --- SYSTEM MODE ---
        function toggleSystemMode() {
            isManualMode = !isManualMode;
            const container = document.querySelector('.mode-switch-container');
            const grid = document.getElementById('deviceGrid');
            const statusText = document.getElementById('sys_status');
            if (isManualMode) {
                container.classList.add('manual'); grid.classList.remove('auto-mode');
                statusText.innerText = "Manual Mode"; statusText.style.color = "var(--warning-color)";
                document.getElementById('modeManual').classList.add('active'); document.getElementById('modeAuto').classList.remove('active');
            } else {
                container.classList.remove('manual'); grid.classList.add('auto-mode');
                statusText.innerText = "Standby (Auto)"; statusText.style.color = "var(--text-main)";
                document.getElementById('modeAuto').classList.add('active'); document.getElementById('modeManual').classList.remove('active');
                document.querySelectorAll('.device-card.active').forEach(c => { c.classList.remove('active'); c.querySelector('.device-status').innerText = 'OFF'; c.querySelector('.device-status').style.color = 'var(--text-secondary)'; c.querySelector('.device-icon').style.color = 'var(--text-secondary)'; });
            }
        }
        function toggleDevice(el) {
            if (!isManualMode) { Swal.fire({ title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Manual?', text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Auto", icon: 'warning', showCancelButton: true, confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î' }).then((r) => { if(r.isConfirmed) toggleSystemMode(); }); return; }
            el.classList.toggle('active');
            const isActive = el.classList.contains('active');
            el.querySelector('.device-status').innerText = isActive ? 'ON' : 'OFF';
            el.querySelector('.device-status').style.color = isActive ? 'var(--success-color)' : 'var(--text-secondary)';
            el.querySelector('.device-icon').style.color = isActive ? 'var(--success-color)' : 'var(--text-secondary)';
        }
        function setDeviceState(id, on) {
            const el = document.getElementById(id); if(!el) return;
            if(on) { el.classList.add('active'); el.querySelector('.device-status').innerText='ON (Auto)'; el.querySelector('.device-status').style.color='var(--success-color)'; el.querySelector('.device-icon').style.color='var(--success-color)'; }
            else { el.classList.remove('active'); el.querySelector('.device-status').innerText='OFF'; el.querySelector('.device-status').style.color='var(--text-secondary)'; el.querySelector('.device-icon').style.color='var(--text-secondary)'; }
        }

        // --- NEW: ULTIMATE DYNAMIC RECIPE CREATION ---
        function filterRecipes(text) {
            const val = text.toLowerCase();
            document.querySelectorAll('#profileTableBody tr').forEach(row => {
                const name = row.querySelector('td:first-child div').innerText.toLowerCase();
                row.style.display = name.includes(val) ? '' : 'none';
            });
        }

        function renderProfiles() {
            const tbody = document.getElementById('profileTableBody');
            tbody.innerHTML = '';
            profiles.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td><div style="font-weight:700; font-size:15px; color:var(--text-main);">${p.name}</div></td>
                        <td><span style="background:#F4F7FE; padding:4px 10px; border-radius:6px; font-weight:600; color:var(--primary-dark);">${p.days} ‡∏ß‡∏±‡∏ô</span></td>
                        <td><small style="color:#aaa;">${p.stages.length} ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</small></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-sm btn-view" onclick="viewProfileDetails(${p.id})"><i class="fa-solid fa-eye"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                <button class="btn-sm btn-add" onclick="openAddModal(${p.id})"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                                <button class="btn-sm btn-del" onclick="deleteProfile(${p.id})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function viewProfileDetails(id) {
            const p = profiles.find(x => x.id == id);
            document.getElementById('viewProfileTitle').innerText = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏ï‡∏£: ${p.name}`;
            const tbody = document.getElementById('viewProfileBody');
            tbody.innerHTML = '';
            p.stages.forEach(s => {
                s.schedules.forEach(sch => {
                    tbody.innerHTML += `<tr>
                        <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${s.start} - ${s.end}</td>
                        <td><strong style="color:var(--primary-dark);">${sch.time}</strong></td>
                        <td>${sch.ec}</td>
                        <td>${sch.ph}</td>
                    </tr>`;
                });
            });
            document.getElementById('viewProfileModal').style.display = 'flex';
        }

        function deleteProfile(id) {
            Swal.fire({ title: '‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#EE5D50', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢' }).then((r) => {
                if (r.isConfirmed) { profiles = profiles.filter(p => p.id !== id); renderProfiles(); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); }
            });
        }

        // --- NEW LOGIC: STAGE BLOCKS ---
        function openCreateRecipeModal() {
            document.getElementById('newRecipeName').value = '';
            document.getElementById('stagesContainer').innerHTML = '';
            document.getElementById('totalDaysDisplay').innerText = '0';
            
            // Add initial block
            addStageBlock(1, 15);
            
            document.getElementById('createRecipeModal').style.display = 'flex';
        }

        function addStageBlock(s='', e='') {
            const container = document.getElementById('stagesContainer');
            const block = document.createElement('div');
            block.className = 'stage-block';
            
            // Block Header: Start/End Date + Delete Block
            let headerHTML = `
                <div style="display:flex; gap:10px; margin-bottom:5px;">
                    <small style="flex:1; color:var(--text-secondary); font-size:12px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Start Day)</small>
                    <small style="flex:0.1;"></small>
                    <small style="flex:1; color:var(--text-secondary); font-size:12px;">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (End Day)</small>
                    <div style="width:36px;"></div>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <div style="flex:1;"><input type="number" class="form-control input-start" placeholder="1" value="${s}"></div>
                    <div style="flex:0.1; text-align:center; color:#aaa; font-weight:bold;">-</div>
                    <div style="flex:1;"><input type="number" class="form-control input-end" placeholder="15" value="${e}" onchange="updateTotalDays()"></div>
                    <button class="btn-sq btn-sq-del" onclick="this.parentElement.parentElement.remove(); updateTotalDays();" title="‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div style="padding-left:10px; margin-bottom:5px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <small style="color:#aaa; font-weight:600;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏ô‡∏µ‡πâ:</small>
                        <button class="btn-sq btn-sq-add" onclick="addSubRow(this)" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="sub-rows-container"></div>
                </div>
            `;
            block.innerHTML = headerHTML;
            container.appendChild(block);
            
            // Add default first sub-row
            const subContainer = block.querySelector('.sub-rows-container');
            addSubRowToContainer(subContainer, "08:00", 1.0, 6.0);
            updateTotalDays();
        }

        function addSubRow(btn) {
            const subContainer = btn.parentElement.parentElement.querySelector('.sub-rows-container');
            addSubRowToContainer(subContainer);
        }

        function addSubRowToContainer(container, t='', ec='', ph='') {
            const row = document.createElement('div');
            row.className = 'sub-row';
            row.innerHTML = `
                <input type="time" class="form-control input-time" value="${t}">
                <input type="number" step="0.1" class="form-control input-ec" placeholder="EC" value="${ec}">
                <input type="number" step="0.1" class="form-control input-ph" placeholder="pH" value="${ph}">
                <button class="btn-sq btn-sq-del" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(row);
        }

        function updateTotalDays() {
            let maxDay = 0;
            document.querySelectorAll('.input-end').forEach(inp => {
                const val = parseInt(inp.value) || 0;
                if(val > maxDay) maxDay = val;
            });
            document.getElementById('totalDaysDisplay').innerText = maxDay;
        }

        function confirmCreateRecipe() {
            const name = document.getElementById('newRecipeName').value;
            const blocks = document.querySelectorAll('.stage-block');
            
            if(!name) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏π‡∏ï‡∏£', '', 'warning'); return; }
            if(blocks.length === 0) { Swal.fire('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å', '', 'warning'); return; }

            let newStages = [];
            let isValid = true;

            blocks.forEach(block => {
                const s = parseInt(block.querySelector('.input-start').value);
                const e = parseInt(block.querySelector('.input-end').value);
                
                if(!s || !e) isValid = false;

                // Collect Sub-rows (Schedules)
                let schedules = [];
                block.querySelectorAll('.sub-row').forEach(row => {
                    const t = row.querySelector('.input-time').value;
                    const ec = parseFloat(row.querySelector('.input-ec').value);
                    const ph = parseFloat(row.querySelector('.input-ph').value);
                    if(!t || isNaN(ec) || isNaN(ph)) isValid = false;
                    schedules.push({ time: t, ec: ec, ph: ph });
                });

                if(schedules.length === 0) isValid = false;

                newStages.push({ start: s, end: e, schedules: schedules });
            });

            if(!isValid) { Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô, ‡πÄ‡∏ß‡∏•‡∏≤, ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ EC/pH', 'warning'); return; }

            newStages.sort((a, b) => a.start - b.start);
            const totalDays = Math.max(...newStages.map(s => s.end));

            profiles.push({ id: Date.now(), name: name, days: totalDays, stages: newStages });
            renderProfiles(); closeModal('createRecipeModal'); Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success');
        }

        // --- ADD TO SCHEDULE LOGIC (UPDATED FOR NESTED STRUCTURE) ---
        function openAddModal(id) {
            selectedProfileId = id;
            const p = profiles.find(x => x.id == id);
            document.getElementById('modalProfileName').innerText = p.name;
            document.getElementById('addScheduleModal').style.display = 'flex';
        }

        function confirmAddToSchedule() {
            const p = profiles.find(x => x.id == selectedProfileId);
            const startDateStr = document.getElementById('inputStartDate').value;
            if(!startDateStr) { Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å', '', 'warning'); return; }

            const startDate = new Date(startDateStr);
            
            p.stages.forEach(stage => {
                // Loop each day in stage
                for(let d = stage.start; d <= stage.end; d++) {
                    let jobDate = new Date(startDate);
                    jobDate.setDate(startDate.getDate() + (d - 1));
                    const dateString = jobDate.toISOString().split('T')[0];

                    // Loop each schedule in that stage
                    stage.schedules.forEach(sch => {
                        mainSchedule.push({
                            id: Date.now() + Math.random(),
                            date: dateString,
                            time: sch.time,
                            taskName: `${p.name} (Day ${d})`,
                            ec: sch.ec,
                            ph: sch.ph,
                            status: 'pending',
                            enabled: true
                        });
                    });
                }
            });

            mainSchedule.sort((a,b) => new Date(a.date+' '+a.time) - new Date(b.date+' '+b.time));
            closeModal('addScheduleModal');
            renderSchedule(); updateDashboard(); switchPage('schedule');
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô ${p.days} ‡∏ß‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            if(mainSchedule.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#aaa;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</td></tr>`; return; }
            let lastDate = '';
            mainSchedule.forEach((job, index) => {
                if (job.date !== lastDate) { tbody.innerHTML += `<tr class="date-header"><td colspan="6"><i class="fa-regular fa-calendar"></i> ${formatDate(job.date)}</td></tr>`; lastDate = job.date; }
                let statusBadge = job.status === 'success' ? '<span class="status-badge bg-success">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>' : (job.status==='running' ? '<span class="status-badge bg-active">Running</span>' : '<span class="status-badge bg-pending">‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>');
                if(!job.enabled) statusBadge = '<span class="status-badge bg-disabled">‡∏Ç‡πâ‡∏≤‡∏°</span>';
                
                tbody.innerHTML += `
                    <tr style="${!job.enabled ? 'opacity:0.5' : ''}">
                        <td></td><td><strong>${job.time}</strong></td>
                        <td>${job.taskName}</td><td>EC ${job.ec} / pH ${job.ph}</td>
                        <td>${statusBadge}</td>
                        <td><div class="action-buttons"><button class="btn-sm btn-edit" onclick="openEditJob(${index})"><i class="fa-solid fa-pen"></i></button><button class="btn-sm btn-toggle ${job.enabled ? 'active':''}" onclick="toggleJob(${index})">${job.enabled ? 'ON':'OFF'}</button></div></td>
                    </tr>`;
            });
        }

        function clearSchedule() { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { mainSchedule=[]; renderSchedule(); updateDashboard(); } }
        function toggleJob(i) { mainSchedule[i].enabled = !mainSchedule[i].enabled; renderSchedule(); updateDashboard(); }
        
        // Manual Job Add/Edit
        function openAddSingleJobModal() { document.getElementById('newJobName').value=''; document.getElementById('addSingleJobModal').style.display='flex'; }
        function saveSingleJob() {
            const d=document.getElementById('newJobDate').value, t=document.getElementById('newJobTime').value, n=document.getElementById('newJobName').value, ec=document.getElementById('newJobEC').value, ph=document.getElementById('newJobPH').value;
            if(!d||!t) return;
            mainSchedule.push({ id:Date.now(), date:d, time:t, taskName:n||"Manual", ec:parseFloat(ec), ph:parseFloat(ph), status:'pending', enabled:true });
            mainSchedule.sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time));
            closeModal('addSingleJobModal'); renderSchedule(); updateDashboard();
        }
        function openEditJob(i) { 
            const j=mainSchedule[i]; document.getElementById('editJobIndex').value=i; document.getElementById('editJobDate').value=j.date; document.getElementById('editJobTime').value=j.time; document.getElementById('editJobEC').value=j.ec; document.getElementById('editJobPH').value=j.ph; 
            document.getElementById('editJobModal').style.display='flex'; 
        }
        function saveJobEdit() {
            const i=document.getElementById('editJobIndex').value;
            mainSchedule[i].date=document.getElementById('editJobDate').value; mainSchedule[i].time=document.getElementById('editJobTime').value;
            mainSchedule[i].ec=parseFloat(document.getElementById('editJobEC').value); mainSchedule[i].ph=parseFloat(document.getElementById('editJobPH').value);
            mainSchedule.sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time));
            closeModal('editJobModal'); renderSchedule(); updateDashboard();
        }

        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const jobs = mainSchedule.filter(j => j.date === today && j.enabled);
            let html = '';
            if(jobs.length===0) html = `<tr><td colspan="4" style="text-align:center; padding:20px; color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
            else jobs.forEach(j => { html += `<tr class="${j.status==='running'?'row-running':''}"><td>${j.time}</td><td>${j.taskName}</td><td>${j.ec}</td><td>${j.status==='success'?'‚úÖ':'‚è≥'}</td></tr>`; });
            document.getElementById('todayTableBody').innerHTML = html;
            
            const next = mainSchedule.find(j => j.status === 'pending' && j.enabled);
            document.getElementById('dash_target_ec').innerText = next ? next.ec : '-';
            document.getElementById('dash_target_ph').innerText = next ? next.ph : '-';
        }

        function runNextJob() {
            if(isManualMode) { Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Auto', '', 'warning'); return; }
            const job = mainSchedule.find(j => j.status === 'pending' && j.enabled);
            if(!job) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á', '', 'info');
            job.status = 'running'; renderSchedule(); updateDashboard();
            
            document.getElementById('sys_status').innerText = "Running...";
            let lv = 10;
            activeInterval = setInterval(() => {
                lv+=1; document.getElementById('mixTank').style.height = lv+'%';
                if(lv<40) { setDeviceState('dev_pumpA',1); setDeviceState('dev_pumpB',0); }
                else if(lv<70) { setDeviceState('dev_pumpA',0); setDeviceState('dev_pumpB',1); }
                else { setDeviceState('dev_pumpB',0); setDeviceState('dev_pumpMix',1); }
                
                if(lv>=90) { 
                    clearInterval(activeInterval); job.status = 'success';
                    ['dev_pumpA','dev_pumpB','dev_pumpMix'].forEach(d=>setDeviceState(d,0));
                    document.getElementById('mixTank').style.height = '10%';
                    document.getElementById('sys_status').innerText = "Standby (Auto)";
                    document.getElementById('historyTableBody').innerHTML = `<tr><td>${formatDate(job.date)} ${job.time}</td><td>${job.taskName}</td><td>OK</td><td>Pass</td></tr>` + document.getElementById('historyTableBody').innerHTML;
                    renderSchedule(); updateDashboard(); Swal.fire('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '', 'success');
                }
            }, 50);
        }

        function emergencyStop() {
            clearInterval(activeInterval); ['dev_pumpA','dev_pumpB','dev_pumpMix'].forEach(d=>setDeviceState(d,0));
            document.getElementById('sys_status').innerText = "Stopped";
            document.getElementById('mixTank').style.height = '10%';
            renderSchedule();
        }

        function formatDate(d) { const D=new Date(d); return `${D.getDate()}/${D.getMonth()+1}/${D.getFullYear()+543}`; }
    </script>
</body>
</html>
